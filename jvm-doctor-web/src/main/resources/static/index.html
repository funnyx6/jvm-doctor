<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>JVM Doctor - ç›‘æ§å¹³å°</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/lib/vue.global.prod.js"></script>
    <script src="/lib/chart.umd.js"></script>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="header-left">
                <h1>ğŸ¾ JVM Doctor</h1>
                <span class="subtitle">JVM ç›‘æ§å¹³å°</span>
            </div>
            <div class="header-right">
                <button class="btn-theme" @click="toggleTheme" :title="darkMode ? 'åˆ‡æ¢äº®è‰²æ¨¡å¼' : 'åˆ‡æ¢æ·±è‰²æ¨¡å¼'">
                    {{ darkMode ? 'â˜€ï¸' : 'ğŸŒ™' }}
                </button>
                <span class="connection-status" :class="wsConnected ? 'online' : 'offline'">
                    {{ wsConnected ? 'â— åœ¨çº¿' : 'â—‹ ç¦»çº¿' }}
                </span>
                <span class="time">{{ currentTime }}</span>
            </div>
        </header>
        
        <main class="main">
            <!-- åº”ç”¨åˆ—è¡¨ -->
            <section class="section apps-section">
                <div class="section-header">
                    <h2>åº”ç”¨åˆ—è¡¨</h2>
                    <span class="badge">{{ runningApps.length }} ä¸ªè¿è¡Œä¸­</span>
                </div>
                <div class="apps-grid">
                    <div v-for="app in apps" :key="app.id" 
                         class="app-card" 
                         :class="{ active: selectedAppId === app.id }"
                         @click="selectApp(app)">
                        <div class="app-status" :class="app.status"></div>
                        <div class="app-info">
                            <h3>{{ app.appName }}</h3>
                            <p>{{ app.host }}:{{ app.port }}</p>
                            <p class="app-meta">{{ app.jvmName }} | {{ formatUptime(app.startTime) }}</p>
                        </div>
                        <div class="app-actions">
                            <button class="btn-sm btn-danger" @click.stop="offlineApp(app)" v-if="app.status === 'running'">ä¸‹çº¿</button>
                            <button class="btn-sm btn-primary" @click.stop="heartbeatApp(app)" v-else>æ¢å¤</button>
                        </div>
                        <div class="app-metrics">
                            <div class="metric">
                                <span class="label">å †å†…å­˜</span>
                                <span class="value">{{ getAppMetric(app.id, 'heapUsage') }}</span>
                            </div>
                            <div class="metric">
                                <span class="label">çº¿ç¨‹</span>
                                <span class="value">{{ getAppMetric(app.id, 'threadCount') }}</span>
                            </div>
                        </div>
                    </div>
                    <div v-if="apps.length === 0" class="empty-state">
                        <p>æš‚æ— æ³¨å†Œçš„åº”ç”¨</p>
                        <p class="hint">å¯åŠ¨ jvm-doctor-agent å³å¯è‡ªåŠ¨æ³¨å†Œ</p>
                    </div>
                </div>
            </section>
            
            <!-- è¯¦æƒ…é¢æ¿ -->
            <section class="section detail-section" v-if="selectedApp">
                <div class="section-header">
                    <h2>{{ selectedApp.appName }}</h2>
                    <div class="header-actions">
                        <button class="btn-detail" @click="showDrawer = true">è¯¦æƒ… â†’</button>
                        <button class="btn-close" @click="selectedAppId = null">Ã—</button>
                    </div>
                </div>
                
                <!-- æ ‡ç­¾é¡µ -->
                <div class="tabs">
                    <button class="tab" :class="{ active: activeTab === 'metrics' }" @click="activeTab = 'metrics'">ç›‘æ§</button>
                    <button class="tab" :class="{ active: activeTab === 'threads' }" @click="activeTab = 'threads'; loadThreads()">çº¿ç¨‹</button>
                </div>
                
                <!-- ç›‘æ§è§†å›¾ -->
                <div v-if="activeTab === 'metrics'">
                    <!-- å®æ—¶å›¾è¡¨ -->
                    <div class="charts-row">
                        <div class="chart-card">
                            <h3>å †å†…å­˜ä½¿ç”¨ç‡</h3>
                            <canvas id="heapChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>CPU ä½¿ç”¨ç‡</h3>
                            <canvas id="cpuChart"></canvas>
                        </div>
                    </div>
                    <div class="charts-row">
                        <div class="chart-card">
                            <h3>çº¿ç¨‹æ•°</h3>
                            <canvas id="threadChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Metaspace ä½¿ç”¨</h3>
                            <canvas id="metaspaceChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- å®æ—¶æŒ‡æ ‡ -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <h4>å †å†…å­˜</h4>
                            <div class="metric-value">
                                {{ formatBytes(currentMetrics.heapUsed) }} / {{ formatBytes(currentMetrics.heapMax) }}
                            </div>
                            <div class="progress-bar">
                                <div class="progress" :style="{ width: (currentMetrics.heapUsage * 100) + '%' }"
                                     :class="getUsageClass(currentMetrics.heapUsage)"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <h4>Metaspace</h4>
                            <div class="metric-value">
                                {{ formatBytes(currentMetrics.metaspaceUsed) }} / {{ formatBytes(currentMetrics.metaspaceMax || 0) }}
                            </div>
                            <div class="metric-sub" v-if="currentMetrics.metaspaceUsage">
                                {{ (currentMetrics.metaspaceUsage * 100).toFixed(1) }}% ä½¿ç”¨ç‡
                            </div>
                        </div>
                        <div class="metric-card">
                            <h4>çº¿ç¨‹æ•°</h4>
                            <div class="metric-value">{{ currentMetrics.threadCount }}</div>
                            <div class="metric-sub">{{ currentMetrics.daemonThreadCount }} å®ˆæŠ¤</div>
                        </div>
                        <div class="metric-card">
                            <h4>CPU ä½¿ç”¨ç‡</h4>
                            <div class="metric-value">{{ (currentMetrics.cpuUsage * 100).toFixed(1) }}%</div>
                        </div>
                        <div class="metric-card">
                            <h4>GC æ¬¡æ•°</h4>
                            <div class="metric-value">{{ currentMetrics.gcCount || 0 }}</div>
                            <div class="metric-sub">{{ formatDuration(currentMetrics.gcTime) }} GCæ—¶é—´</div>
                        </div>
                        <div class="metric-card">
                            <h4>è¿è¡Œæ—¶é•¿</h4>
                            <div class="metric-value">{{ formatDuration(currentMetrics.uptime) }}</div>
                        </div>
                    </div>
                    
                    <!-- æ€§èƒ½å»ºè®® -->
                    <div class="suggestions-section" v-if="suggestions.length > 0">
                        <div class="section-header">
                            <h3>ğŸ’¡ æ€§èƒ½å»ºè®®</h3>
                        </div>
                        <div class="suggestions-list">
                            <div v-for="(item, index) in suggestions" :key="index" 
                                 class="suggestion-item" :class="item.level">
                                <div class="suggestion-icon">
                                    {{ item.level === 'critical' ? 'ğŸ”´' : item.level === 'warning' ? 'ğŸŸ¡' : 'ğŸŸ¢' }}
                                </div>
                                <div class="suggestion-content">
                                    <div class="suggestion-title">{{ item.title }}</div>
                                    <div class="suggestion-desc">{{ item.desc }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- çº¿ç¨‹è§†å›¾ -->
                <div v-if="activeTab === 'threads'" class="thread-view">
                    <!-- çº¿ç¨‹ç»Ÿè®¡ -->
                    <div class="thread-stats">
                        <div class="stat-item">
                            <span class="stat-value">{{ threadData.totalCount || 0 }}</span>
                            <span class="stat-label">æ€»çº¿ç¨‹æ•°</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" :class="threadData.deadlockCount > 0 ? 'text-danger' : ''">{{ threadData.deadlockCount || 0 }}</span>
                            <span class="stat-label">æ­»é”çº¿ç¨‹</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ threadData.runnableCount || 0 }}</span>
                            <span class="stat-label">è¿è¡Œä¸­</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ threadData.waitingCount || 0 }}</span>
                            <span class="stat-label">ç­‰å¾…ä¸­</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ threadData.timedWaitingCount || 0 }}</span>
                            <span class="stat-label">å®šæ—¶ç­‰å¾…</span>
                        </div>
                    </div>
                    
                    <!-- åˆ·æ–°æŒ‰é’® -->
                    <div class="thread-actions">
                        <button class="btn-primary" @click="loadThreads" :disabled="loadingThreads">
                            {{ loadingThreads ? 'åŠ è½½ä¸­...' : 'åˆ·æ–°' }}
                        </button>
                        <span class="thread-time" v-if="threadData.timestamp">æ›´æ–°æ—¶é—´ï¼š{{ formatTime(threadData.timestamp) }}</span>
                    </div>
                    
                    <!-- CPU Top çº¿ç¨‹ -->
                    <div class="thread-section">
                        <h3>ğŸ”¥ CPU å ç”¨ Top 10</h3>
                        <div class="thread-list top-list">
                            <div v-for="(thread, index) in threadData.topThreads" :key="thread.threadId" 
                                 class="thread-item" :class="{ selected: selectedThreadId === thread.threadId }"
                                 @click="selectThread(thread)">
                                <div class="thread-rank">{{ index + 1 }}</div>
                                <div class="thread-info">
                                    <div class="thread-name">{{ thread.name }}</div>
                                    <div class="thread-meta">
                                        <span class="state-badge" :class="getStateClass(thread.state)">{{ thread.state }}</span>
                                        <span class="cpu-time">{{ formatCpuTime(thread.cpuTimeMillis) }}</span>
                                    </div>
                                </div>
                                <div class="thread-cpu">
                                    <div class="cpu-bar">
                                        <div class="cpu-used" :style="{ width: getCpuPercent(thread) + '%' }"></div>
                                    </div>
                                    <span class="cpu-percent">{{ getCpuPercent(thread).toFixed(1) }}%</span>
                                </div>
                            </div>
                            <div v-if="!threadData.topThreads || threadData.topThreads.length === 0" class="empty-state">
                                <p>æš‚æ— çº¿ç¨‹æ•°æ®</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çº¿ç¨‹è¯¦æƒ… -->
                    <div class="thread-section" v-if="selectedThread">
                        <h3>ğŸ“‹ çº¿ç¨‹è¯¦æƒ…</h3>
                        <div class="thread-detail">
                            <div class="detail-header">
                                <div class="detail-title">
                                    <span class="state-badge large" :class="getStateClass(selectedThread.state)">{{ selectedThread.state }}</span>
                                    <span class="thread-name">{{ selectedThread.name }}</span>
                                    <span class="thread-id">#{{ selectedThread.threadId }}</span>
                                </div>
                                <button class="btn-close" @click="selectedThreadId = null">Ã—</button>
                            </div>
                            <div class="detail-info">
                                <div class="info-row">
                                    <span class="label">CPU æ—¶é—´</span>
                                    <span class="value">{{ formatCpuTime(selectedThread.cpuTimeMillis) }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">ä¼˜å…ˆçº§</span>
                                    <span class="value">{{ selectedThread.priority }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">å®ˆæŠ¤çº¿ç¨‹</span>
                                    <span class="value">{{ selectedThread.daemon ? 'æ˜¯' : 'å¦' }}</span>
                                </div>
                                <div class="info-row" v-if="selectedThread.lockOwnerName">
                                    <span class="label">é”æŒæœ‰è€…</span>
                                    <span class="value">{{ selectedThread.lockOwnerName }} (#{{ selectedThread.lockOwnerId }})</span>
                                </div>
                                <div class="info-row" v-if="selectedThread.lockName">
                                    <span class="label">ç­‰å¾…é”</span>
                                    <span class="value">{{ selectedThread.lockName }}</span>
                                </div>
                            </div>
                            <!-- å †æ ˆ -->
                            <div class="stack-trace" v-if="selectedThread.stackTrace && selectedThread.stackTrace.length > 0">
                                <h4>å †æ ˆä¿¡æ¯</h4>
                                <div class="stack-list">
                                    <div v-for="(frame, idx) in selectedThread.stackTrace" :key="idx" class="stack-frame">
                                        <span class="stack-class">{{ frame.className }}</span>
                                        <span class="stack-method">{{ frame.methodName }}</span>
                                        <span class="stack-location" v-if="frame.nativeMethod === 'true'">(Native Method)</span>
                                        <span class="stack-location" v-else>{{ frame.fileName }}:{{ frame.lineNumber }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ­»é”å‘Šè­¦ -->
                    <div class="alert-danger" v-if="threadData.deadlockCount > 0">
                        <span class="alert-icon">âš ï¸</span>
                        <span>æ£€æµ‹åˆ° {{ threadData.deadlockCount }} ä¸ªæ­»é”çº¿ç¨‹ï¼</span>
                        <button class="btn-danger" @click="showDeadlocks = true">æŸ¥çœ‹è¯¦æƒ…</button>
                    </div>
                    
                    <!-- æ­»é”åˆ—è¡¨å¼¹çª— -->
                    <div class="modal-overlay" v-if="showDeadlocks" @click="showDeadlocks = false">
                        <div class="modal large" @click.stop>
                            <div class="modal-header">
                                <h3>âš ï¸ æ­»é”çº¿ç¨‹</h3>
                                <button class="btn-close" @click="showDeadlocks = false">Ã—</button>
                            </div>
                            <div class="modal-body">
                                <div v-for="(deadlock, idx) in threadData.deadlocks" :key="idx" class="deadlock-item">
                                    <div class="deadlock-title">
                                        <span class="state-badge danger">DEADLOCK</span>
                                        <span class="thread-name">{{ deadlock.name }} (#{{ deadlock.threadId }})</span>
                                    </div>
                                    <div class="deadlock-info">
                                        <span class="label">çŠ¶æ€ï¼š</span><span>{{ deadlock.state }}</span>
                                    </div>
                                    <div class="deadlock-info">
                                        <span class="label">ç­‰å¾…é”ï¼š</span><span>{{ deadlock.lockName }}</span>
                                    </div>
                                    <div class="deadlock-info" v-if="deadlock.lockOwnerName">
                                        <span class="label">æŒæœ‰é”ï¼š</span><span>{{ deadlock.lockOwnerName }}</span>
                                    </div>
                                    <div class="stack-trace small" v-if="deadlock.stackTrace">
                                        <div v-for="(frame, fidx) in deadlock.stackTrace.slice(0, 5)" :key="fidx" class="stack-frame">
                                            <span class="stack-class">{{ frame.className }}</span>
                                            <span class="stack-method">{{ frame.methodName }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- åº”ç”¨è¯¦æƒ…æŠ½å±‰ -->
            <div class="drawer-overlay" v-if="showDrawer" @click="showDrawer = false"></div>
            <div class="drawer" :class="{ open: showDrawer }">
                <div class="drawer-header">
                    <h3>åº”ç”¨è¯¦æƒ…</h3>
                    <button class="btn-close" @click="showDrawer = false">Ã—</button>
                </div>
                <div class="drawer-content">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="drawer-section">
                        <h4>åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">åº”ç”¨åç§°</span>
                                <span class="value">{{ selectedApp?.appName }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">ä¸»æœº</span>
                                <span class="value">{{ selectedApp?.host }}:{{ selectedApp?.port }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">JVM ç‰ˆæœ¬</span>
                                <span class="value">{{ selectedApp?.jvmVersion }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">å¯åŠ¨æ—¶é—´</span>
                                <span class="value">{{ formatDate(selectedApp?.startTime) }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å†…å­˜è¯¦æƒ… -->
                    <div class="drawer-section">
                        <h4>å†…å­˜è¯¦æƒ…</h4>
                        <div class="memory-pools">
                            <div class="pool-item">
                                <span class="pool-name">å †å†…å­˜ (Heap)</span>
                                <div class="pool-bar">
                                    <div class="pool-used" :style="{ width: (currentMetrics.heapUsage * 100) + '%' }"></div>
                                </div>
                                <span class="pool-value">{{ formatBytes(currentMetrics.heapUsed) }} / {{ formatBytes(currentMetrics.heapMax) }}</span>
                            </div>
                            <div class="pool-item">
                                <span class="pool-name">Metaspace</span>
                                <div class="pool-bar">
                                    <div class="pool-used" :style="{ width: (currentMetrics.metaspaceUsage * 100) + '%' }"></div>
                                </div>
                                <span class="pool-value">{{ formatBytes(currentMetrics.metaspaceUsed) }} / {{ formatBytes(currentMetrics.metaspaceMax || 0) }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GC ç»Ÿè®¡ -->
                    <div class="drawer-section">
                        <h4>GC ç»Ÿè®¡</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value">{{ currentMetrics.gcCount || 0 }}</span>
                                <span class="stat-label">GC æ¬¡æ•°</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ formatDuration(currentMetrics.gcTime) }}</span>
                                <span class="stat-label">GC è€—æ—¶</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ currentMetrics.gcTime > 0 ? (currentMetrics.uptime / currentMetrics.gcTime).toFixed(0) : '-' }}</span>
                                <span class="stat-label"> uptime/GCæ¯”ç‡</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çº¿ç¨‹ç»Ÿè®¡ -->
                    <div class="drawer-section">
                        <h4>çº¿ç¨‹ç»Ÿè®¡</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value">{{ currentMetrics.threadCount }}</span>
                                <span class="stat-label">æ€»çº¿ç¨‹æ•°</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ currentMetrics.daemonThreadCount }}</span>
                                <span class="stat-label">å®ˆæŠ¤çº¿ç¨‹</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ currentMetrics.threadCount - currentMetrics.daemonThreadCount }}</span>
                                <span class="stat-label">ç”¨æˆ·çº¿ç¨‹</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- JVM å‚æ•° -->
                    <div class="drawer-section">
                        <h4>JVM å‚æ•°</h4>
                        <div class="jvm-params">
                            <code>-Xmx{{ formatBytes(currentMetrics.heapMax) }}</code>
                            <code>-Xms{{ formatBytes(currentMetrics.heapMax * 0.5) }}</code>
                            <code>-XX:MaxMetaspaceSize={{ formatBytes(currentMetrics.metaspaceMax || 268435456) }}</code>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å‘Šè­¦é¢æ¿ -->
            <section class="section alerts-section">
                <div class="section-header">
                    <h2>å‘Šè­¦ä¸­å¿ƒ</h2>
                    <span class="badge danger" v-if="unacknowledgedCount > 0">{{ unacknowledgedCount }} ä¸ªæœªå¤„ç†</span>
                </div>
                <div class="alerts-list">
                    <div v-for="alert in alerts" :key="alert.id" class="alert-item" :class="alert.alertLevel">
                        <div class="alert-icon">
                            {{ alert.alertLevel === 'critical' ? 'ğŸ”´' : alert.alertLevel === 'warning' ? 'ğŸŸ¡' : 'ğŸ”µ' }}
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">{{ alert.alertType }}</div>
                            <div class="alert-msg">{{ alert.alertMsg }}</div>
                            <div class="alert-meta">
                                {{ getAppName(alert.appId) }} | {{ formatTime(alert.createdAt) }}
                            </div>
                        </div>
                        <button v-if="!alert.acknowledged" class="btn-ack" @click="acknowledgeAlert(alert.id)">
                            ç¡®è®¤
                        </button>
                        <span v-else class="ack-label">å·²ç¡®è®¤</span>
                    </div>
                    <div v-if="alerts.length === 0" class="empty-state">
                        <p>æš‚æ— å‘Šè­¦</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <script src="/js/app.js"></script>
</body>
</html>
